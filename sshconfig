#!/bin/bash

# 2014 Jon Suderman
# https://github.com/suderman/sshconfig

# Expand tilde just in case
SSH_HOME="~/.ssh"
eval SSH_HOME=$SSH_HOME

# Expand tilde just in case
[ -z "$SSH_CONFIGS" ] && SSH_CONFIGS="$SSH_HOME"
eval SSH_CONFIGS=$SSH_CONFIGS

# Where the .ssh/config is saved
output="$HOME/.ssh/config"

# Main
__sshconfig() {

  # Clear out ssh/config
  # mv -f $HOME/.ssh/config $HOME/.ssh/config.backup 
  mv -f "$output" "$output.backup" 
  echo "# Generated by sshconfig" >> $output
  echo "# https://github.com/suderman/sshconfig" >> $output
  echo "#" >> $output
  echo "# Do not edit this file!" >> $output
  echo "# Run \`sshconfig\` to generate this file from $SSH_CONFIGS/config.*" >> $output
  echo "" >> $output

  # Look for all ssh configs 
  for path in $SSH_CONFIGS/config.*; do
    if [ -f $path ]; then
      config=$(basename "$path")

      # Skip over default and backup
      case "$config" in
        config.default) ;;
        config.backup) ;;

        # Copy config & actually use environment variables
        *) __cp $SSH_CONFIGS/$config ;;
      esac
    fi
  done

  # Concate default at the bottom
  if [ -f $SSH_CONFIGS/config.default ]; then
    __cp $SSH_CONFIGS/config.default
  fi

  # Set generated config to read-only
  chmod 400 "$output"

  # Done!
  echo "Saved to $output"
}


# Concat config.* to config, expanding environment variables long the way
__cp() {
  input=$1
  echo $(basename "$input")

  # Header for each config file
  div="#-----------------------------------------------------------------------------#"
  echo $div >> $output
  echo "# $input" >> $output
  echo $div >> $output

  # Search and replace
  # http://stackoverflow.com/questions/2914220/
  cat $input | \
  while read line ; do

    # Replace environment variables with values
    while [[ "$line" =~ (\$[a-zA-Z_][a-zA-Z_0-9]*) ]] ; do
      LHS=${BASH_REMATCH[1]}
      RHS="$(eval echo "\"$LHS\"")"
      line=${line//$LHS/$RHS}
    done

    # Echo to output without expanding wildcards
    set -f && echo $line >> $output
  done
}

# May as well fix permissions while we're at it
__sshpermissions() {
  chmod 700 $SSH_HOME

  # Set known_hosts to write by owner, read-only by all
  f="$SSH_HOME/known_hosts"
  [ -f "$f" ] && chmod 644 $f

  # Set authorized_keys to read-write by owner
  f="$SSH_HOME/authorized_keys"
  [ -f "$f" ] && chmod 600 $f

  # Set all private keys to read-only by owner
  for f in $SSH_HOME/id_*; do
    [ -f "$f" ] && chmod 400 $f
  done
  for f in $SSH_HOME/*_rsa; do
    [ -f "$f" ] && chmod 400 $f
  done
  for f in $SSH_HOME/*_dsa; do
    [ -f "$f" ] && chmod 400 $f
  done
  for f in $SSH_HOME/*.pem; do
    [ -f "$f" ] && chmod 400 $f
  done

  # Set all public keys to read-only by all
  for f in $SSH_HOME/*.pub; do
    [ -f "$f" ] && chmod 444 $f
  done

  # Done!
  echo "Verified permissions in $SSH_HOME"
}

# Verify permissions
__sshpermissions

# Run the config
__sshconfig

